<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>All Suggestions - Admin</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <style>
    body {
      background-color: #283e96c4;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .admin-header {
      background: linear-gradient(to right, #004080, #0066cc);
      color: white;
      padding: 25px 30px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }
    .admin-header h2 {
      margin: 0;
      font-size: 1.9rem;
      font-weight: 600;
    }
    .card {
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
      border: none;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.1);
      background-color: #ffffff;
    }
    .dropdown-menu {
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .dropdown-item:hover {
      background-color: #f0f2f5;
      color: #0d6efd;
      font-weight: 500;
    }
    .vote-count {
      color: #0056b3;
      font-weight: 600;
    }
    .suggestion-card .comment-box {
      max-height: 300px;
      overflow-y: auto;
      background-color: #f8f9fa;
      padding: 10px;
      border-radius: 10px;
    }
    .btn-primary:hover,
    .btn-primary:focus {
      background-color: #0d6efd;
      box-shadow: 0 4px 12px rgba(13, 110, 253, 0.4);
      color: #fff;
    }
    select.form-select {
      border-radius: 8px;
      padding: 6px 10px;
      background-color: #f8f9fa;
      font-size: 0.9rem;
      margin-top: 10px;
      max-width: 180px;
    }
    select.form-select:focus {
      border-color: #0d6efd;
      box-shadow: 0 0 0 0.15rem rgba(13, 110, 253, 0.25);
    }
    .form-select option {
      padding: 6px;
    }
    .comments p {
      background-color: #fff;
      border-left: 4px solid #0d6efd;
      padding: 10px 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      font-size: 0.9rem;
    }
    .comments small {
      font-size: 0.75rem;
      color: #6c757d;
    }
    textarea.form-control {
      border-radius: 8px;
      resize: none;
    }
    select.form-select.form-select-sm.mt-2 {
      padding: 0.25rem 0.5rem;
      font-size: 0.85rem;
      width: auto;
      max-width: 160px;
      margin-top: 0.5rem;
    }
    .top-right {
      position: absolute;
      top: 20px;
      right: 20px;
    }

    .top-right button {
      padding: 12px 24px;
      border: none;
      border-radius: 20px;
      background-color: #0056b3;
      color: white;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }

    .top-right button:hover {
      background-color: #003d80;
    }
  </style>
</head>
<body>
  <div class="top-right">
        <button onclick="location.href='/viewadmin'">View Admin Options</button>
    </div>
  <div class="container mt-5">
    <div class="admin-header d-flex justify-content-between align-items-center flex-wrap">
      <h2>Admin Suggestions Dashboard</h2>
      <div class="d-flex flex-wrap align-items-center mt-3 mt-md-0">
        <div class="input-group me-2" style="max-width: 250px;">
          <input
            type="text"
            id="searchInput"
            onkeyup="filterSuggestions()"
            class="form-control"
            placeholder="Search suggestions..."
            aria-label="Search suggestions"
          />
          <span class="input-group-text"><i class="fas fa-search"></i></span>
        </div>
        <div class="dropdown me-2">
          <button
            class="btn btn-light dropdown-toggle"
            type="button"
            id="facultyDropdownBtn"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            Filter by Faculty: <span id="selectedFaculty">All Faculties</span>
          </button>
          <ul class="dropdown-menu" aria-labelledby="facultyDropdownBtn" id="facultyDropdownMenu">
            <li><a class="dropdown-item active" href="#" data-faculty="All">All Faculties</a></li>
            <li><a class="dropdown-item" href="#" data-faculty="FCI">FCI</a></li>
            <li><a class="dropdown-item" href="#" data-faculty="FOE">FOE</a></li>
            <li><a class="dropdown-item" href="#" data-faculty="FOM">FOM</a></li>
            <li><a class="dropdown-item" href="#" data-faculty="FCM">FCM</a></li>
            <li><a class="dropdown-item" href="#" data-faculty="FAC">FAC</a></li>
            <li><a class="dropdown-item" href="#" data-faculty="FCA">FCA</a></li>
          </ul>
        </div>
        <div class="dropdown">
          <button
            class="btn btn-light dropdown-toggle"
            type="button"
            id="SortDropdown"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            <i class="fas fa-filter me-1"></i> Sort
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="SortDropdown" id="sortDropdownMenu">
            <li><a href="#" class="dropdown-item" onclick="sortByVotes(event)"><i class="fas fa-arrow-up-wide-short me-2"></i> Upvoted</a></li>
            <li><a href="#" class="dropdown-item" onclick="sortByStatus(event)"><i class="fas fa-list-check me-2"></i> Status</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div id="suggestions">
      {% for suggestion in suggestions %}
      <div
        class="card suggestion-card mb-4"
        data-id="{{ suggestion.id }}"
        data-votes="{{ suggestion.votes }}"
        data-search="{{ (suggestion.suggestion + ' ' + suggestion.reason).lower() }}"
      >
        <div class="card-body">
          <h5 class="card-title">{{ suggestion.suggestion }}</h5>
          <h6 class="card-subtitle mb-2 text-muted">{{ suggestion.faculty }}</h6>
          <p class="card-text">{{ suggestion.reason }}</p>
          <p class="vote-count">Votes: {{ suggestion.votes }}</p>

          <label for="statusSelect{{ suggestion.id }}">Status:</label>
          <select
            id="statusSelect{{ suggestion.id }}"
            class="form-select form-select-sm mt-2"
            onchange="updateStatus({{ suggestion.id }}, this.value)"
          >
            <option value="Pending" {% if suggestion.status == 'Pending' %}selected{% endif %}>Pending</option>
            <option value="In Progress" {% if suggestion.status == 'In Progress' %}selected{% endif %}>In Progress</option>
            <option value="Resolved" {% if suggestion.status == 'Resolved' %}selected{% endif %}>Resolved</option>
          </select>

          <button class="btn btn-primary mt-3" onclick="toggleComments(this)">View Comments</button>
          <div class="comment-box d-none mt-3">
            <div class="comments"></div>
          </div>
        </div>
      </div>
      {% else %}
      <p>No suggestions found.</p>
      {% endfor %}
    </div>
  </div>

  <script>
    let selectedFaculty = "All";

    function toggleComments(button) {
      const cardBody = button.closest(".card-body");
      const commentBox = cardBody.querySelector(".comment-box");
      commentBox.classList.toggle("d-none");

      if (!commentBox.classList.contains("loaded")) {
        const postId = cardBody.closest(".card").dataset.id;
        fetch(`/get_comments/${postId}`)
          .then((res) => res.json())
          .then((data) => {
            const commentsContainer = commentBox.querySelector(".comments");
            commentsContainer.innerHTML = data
              .map(
                (c) =>
                  `<p><strong>${c.username}:</strong> ${c.content}<br><small class="text-muted">${c.timestamp}</small></p>`
              )
              .join("");
            commentBox.classList.add("loaded");
          })
          .catch(() => {
            commentBox.querySelector(".comments").innerHTML =
              "<p>Error loading comments.</p>";
          });
      }
    }

    function updateStatus(postId, newStatus) {
      fetch(`/admin/update_status/${postId}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          // Include CSRF token header here if needed by your backend
        },
        body: JSON.stringify({ status: newStatus }),
      }).catch(() => {
        alert("Failed to update status");
      });
    }

    function sortByVotes(event) {
      event.preventDefault();
      const container = document.getElementById("suggestions");
      const cards = Array.from(container.querySelectorAll(".suggestion-card"));
      cards.sort(
        (a, b) => parseInt(b.dataset.votes, 10) - parseInt(a.dataset.votes, 10)
      );
      container.innerHTML = "";
      cards.forEach((card) => container.appendChild(card));
    }

    function sortByStatus(event) {
      event.preventDefault();
      const statusOrder = { "Pending": 1, "In Progress": 2, "Resolved": 3 };
      const container = document.getElementById("suggestions");
      const cards = Array.from(container.querySelectorAll(".suggestion-card"));
      cards.sort((a, b) => {
        const aStatus = a.querySelector("select").value;
        const bStatus = b.querySelector("select").value;
        return statusOrder[aStatus] - statusOrder[bStatus];
      });
      container.innerHTML = "";
      cards.forEach((card) => container.appendChild(card));
    }

    function filterSuggestions() {
      const searchInput = document.getElementById("searchInput").value.toLowerCase();
      const container = document.getElementById("suggestions");
      const cards = container.querySelectorAll(".suggestion-card");

      cards.forEach((card) => {
        const text = card.dataset.search;
        const faculty = card.querySelector(".card-subtitle").textContent.trim();

        // Check faculty filter
        const facultyMatch = selectedFaculty === "All" || faculty === selectedFaculty;

        // Check search text
        const searchMatch = text.includes(searchInput);

        card.style.display = facultyMatch && searchMatch ? "" : "none";
      });
    }

    // Faculty filter dropdown logic
    document.querySelectorAll("#facultyDropdownMenu .dropdown-item").forEach((item) => {
      item.addEventListener("click", (e) => {
        e.preventDefault();
        selectedFaculty = e.target.dataset.faculty === "All" ? "All" : e.target.dataset.faculty;
        document.getElementById("selectedFaculty").textContent =
          selectedFaculty === "All" ? "All Faculties" : selectedFaculty;

        // Update active class on dropdown items
        document.querySelectorAll("#facultyDropdownMenu .dropdown-item").forEach((el) => {
          el.classList.remove("active");
        });
        e.target.classList.add("active");

        filterSuggestions();
      });
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
