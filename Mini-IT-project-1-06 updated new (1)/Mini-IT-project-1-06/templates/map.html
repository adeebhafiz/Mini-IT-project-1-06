<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MMU Campus Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Stylesheets -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #f8f9fa;
      overflow-x: hidden;
    }
    
    /* Header styling */
    .map-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      background: rgb(158, 178, 221);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      z-index: 1000;
      gap: 15px; /* Space between items */
    }
    
    .map-header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      color: #004080;
      margin: 0;
      white-space: nowrap;
    }
    
    /* Header items container */
    .header-items {
      display: flex;
      align-items: center;
      gap: 15px; /* Space between items */
    }
    
    /* Heatmap toggle switch */
    .form-check.form-switch {
      margin: 0;
      padding: 5px 0;
      white-space: nowrap;
    }
    
    .form-check-input {
      margin-right: 5px;
    }
    
    /* Dashboard button */
    .btn-go-dashboard {
      background: linear-gradient(45deg, #ff6a00, #ee0979);
      color: white;
      font-weight: 600;
      border: none;
      border-radius: 25px;
      padding: 8px 18px;
      font-size: 0.95rem;
      box-shadow: 0 4px 12px rgba(238, 9, 121, 0.6);
      transition: all 0.3s ease;
      white-space: nowrap;
      cursor: pointer;
    }
    
    .btn-go-dashboard:hover {
      background: linear-gradient(45deg, #ee0979, #ff6a00);
      box-shadow: 0 6px 20px rgba(255, 106, 0, 0.7);
      transform: translateY(-2px);
    }
    
    /* Home button */
    .top-right button {
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      background-color: #0056b3;
      color: white;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      transition: background-color 0.3s ease;
      white-space: nowrap;
    }
    
    .top-right button:hover {
      background-color: #003d80;
    }
    
    /* Keep your existing styles for other elements */
    #side-panel {
      position: fixed;
      top: 0;
      left: 0;
      width: 250px;
      height: 100%;
      background: rgb(123, 145, 181);
      box-shadow: 2px 0 5px rgba(0,0,0,0.2);
      border-top-right-radius: 15px;
      border-bottom-right-radius: 15px;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 998;
    }
    #side-panel.open {
      transform: translateX(0);
    }
    .side-panel-open #map {
      width: calc(100% - 250px);
      margin-left: 250px;
      transition: all 0.3s ease;
    }
    #side-content {
      padding: 20px;
    }
    
    #toggle-button {
      position: absolute;
      top: 10px;       
      left: -50px;     
      z-index: 1000;
      background-color: #004080;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      transition: background-color 0.3s ease;
    }
    
    #map {
      flex-grow: 1;
      height: 90vh;
      margin: 5vh auto;
      width: 90vw;
      border-radius: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      transition: margin-left 0.3s;
    }
  </style>
</head>
<body>
  <header class="map-header">MMU Campus Map</h1>

    <div class="header-items">
        <!-- Heatmap toggle switch container -->
      <div class="form-check form-switch m-0" style="user-select:none;">
        <input class="form-check-input" type="checkbox" id="heatmapToggleSwitch" checked>
        <label class="form-check-label" for="heatmapToggleSwitch" id="heatmapToggleLabel" style="font-weight: 600; cursor: pointer;">
          ðŸ”¥ Heatmap: ON
        </label>
      </div>

      <!-- Go to Dashboard button -->
      <button
        onclick="window.location.href='/admin_suggest'"
        class="btn btn-gradient btn-go-dashboard"
        title="Go to Admin Dashboard"
        style="white-space: nowrap;"
      >
        <i class="fas fa-tachometer-alt me-2"></i> Go to Dashboard
      </button>

      <div class="top-right">
        <button onclick="location.href='/viewadmin'">View Admin Options</button>
      </div>
    </div>
    
    
    
  </header>


  <div id="side-panel">
    <div id="side-content">
      <h4>MMU Faculties</h4>
      <ul>
        <li>FCI - Computing & Informatics</li>
        <li>FOE - Engineering</li>
        <li>FOM - Management</li>
        <li>FCM - Creative Multimedia</li>
        <li>FAC - Applied Communication</li>
        <li>FCA - Cinematic Arts</li>
      </ul>
    </div>
  </div>

  <div class="container" style="position: relative;">
  <button id="toggle-button" style="
    position: absolute;
    top: 10px;
    left: -50px;  /* position it just left of the map */
    z-index: 1000;
    background-color: #004080;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  ">â˜°</button>

  <div id="map"></div>
</div>


  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <script>
    // Initialize the map
    const map = L.map("map", {
      center: [2.927909, 101.6417899],
      zoom: 17,
      maxBounds: [[-90, -180], [90, 180]],
      scrollWheelZoom: false,
      dragging: false
    });

    L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      minZoom: 17,
      maxZoom: 19,
    }).addTo(map);

    // Faculty coordinates
    const facultyCoords = {
      "MMU": [2.927990, 101.641928],
      "FAC": [2.925879, 101.642479],
      "FCI": [2.929106, 101.640585],
      "FOE": [2.926426, 101.641431],
      "FCA": [2.926225, 101.642355],
      "FOM": [2.930069, 101.641008],
      "FCM": [2.926142, 101.643171]
    };

    // Layer to hold markers
    const markerLayer = L.layerGroup().addTo(map);

    // Global variables for heatmap layer and its visibility
    let heatmapVisible = true;
    let heatLayer;

    // Function to smoothly fade heatmap
    function fadeHeatmap(toOpacity, duration = 500) {
      if (!heatLayer || !heatLayer._heat || !heatLayer._canvas) return;

      const canvas = heatLayer._canvas;
      const startOpacity = parseFloat(canvas.style.opacity || 1);
      const delta = toOpacity - startOpacity;
      const startTime = performance.now();

      function animateOpacity(time) {
        const elapsed = time - startTime;
        const progress = Math.min(elapsed / duration, 1);
        canvas.style.opacity = startOpacity + delta * progress;

        if (progress < 1) {
          requestAnimationFrame(animateOpacity);
        } else {
          canvas.style.opacity = toOpacity;
        }
      }

      requestAnimationFrame(animateOpacity);
    }

    // Custom Toggle Switch Event Listener
    document.getElementById("heatmapToggleSwitch").addEventListener("change", function () {
      heatmapVisible = this.checked;
      if (heatLayer && heatLayer._canvas) {
        fadeHeatmap(heatmapVisible ? 1 : 0);
      }
      // Update the label text to reflect the new state
      document.getElementById("heatmapToggleLabel").textContent = heatmapVisible ? "ðŸ”¥ Heatmap: ON" : "ðŸ’¤ Heatmap: OFF";
    });

    // Function to update markers and the heatmap layer
    function updateMapMarkers() {
      markerLayer.clearLayers();

      fetch('/faculty_counts')
        .then(res => res.json())
        .then(data => {
          const heatPoints = [];

          for (const [faculty, coords] of Object.entries(facultyCoords)) {
            const count = data[faculty] || 0;
            const label = faculty === 'MMU'
              ? "Multimedia University"
              : `<b>${faculty}</b><br><i class='fas fa-flag text-danger'></i> ${count} suggestion${count !== 1 ? 's' : ''}`;

            // Add marker with a nicer, Bootstrap-styled popup
            L.marker(coords)
              .bindPopup(`
                <div class="card" style="min-width: 200px;">
                  <div class="card-body p-2">
                    <h6 class="card-title mb-1">${faculty}</h6>
                    <p class="card-text mb-0">${count} suggestion${count !== 1 ? 's' : ''}</p>
                  </div>
                </div>
              `)
              .bindTooltip(label, { sticky: true })
              .addTo(markerLayer);

            // If count is positive, add point to heatmap (using count as intensity)
            if (count > 0) {
              heatPoints.push([...coords, count]);
            }
          }

          // Remove any existing heatLayer from the map
          if (heatLayer) {
            map.removeLayer(heatLayer);
          }
          // Create a new heatLayer with the updated points
          heatLayer = L.heatLayer(heatPoints, { radius: 25, blur: 15, maxZoom: 19 });
          // Set initial opacity
          heatLayer.on("load", function () {
            if (heatLayer._canvas) {
              heatLayer._canvas.style.transition = 'opacity 0.3s ease';
              heatLayer._canvas.style.opacity = heatmapVisible ? 1 : 0;
            }
          });
          // Add the heatLayer to the map if visible
          if (heatmapVisible) {
            map.addLayer(heatLayer);
          } else {
            // Even if not visible, add it so we can fade later
            map.addLayer(heatLayer);
            if (heatLayer._canvas) {
              heatLayer._canvas.style.opacity = 0;
            }
          }
        })
        .catch(err => {
          console.error("Could not load counts, fallback markers only.");
          for (const [faculty, coords] of Object.entries(facultyCoords)) {
            const label = faculty === 'MMU' ? "Multimedia University" : faculty;
            L.marker(coords)
              .bindPopup(label)
              .bindTooltip(label, { sticky: true })
              .addTo(markerLayer);
          }
        });
    }

    updateMapMarkers();
    map.fitBounds([[2.9245, 101.638], [2.9305, 101.644]]);

    // Sidebar toggle button event listener
    document.getElementById('toggle-button').addEventListener('click', () => {
      document.getElementById('side-panel').classList.toggle('open');
      document.body.classList.toggle('side-panel-open');
    });

  </script>
</body>
</html>